<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài giảng: Sự Nóng Chảy & Sự Hóa Hơi - Thầy Lâm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0KOVEMQNogPSesLpv5Fl5dokSDltihLAuhjJpcUGGlc/CUIa/ImFSH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIOOTenRwTBXdmRQwI7CMiUI/bosXvLG7FmUYMAHDDEEOoGfdEu" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>

    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tab-btn {
            color: #64748B;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-btn:hover {
            color: #0F172A;
        }
        .tab-btn.active {
            color: #F97316;
            border-bottom-color: #F97316;
            font-weight: 700;
        }
         .tab-btn.quiz-tab.active {
             color: #16A34A;
             border-bottom-color: #16A34A;
        }
        .quiz-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .quiz-option.correct {
            background-color: #16A34A;
            color: white;
            border-color: #16A34A;
        }
        .quiz-option.incorrect {
            background-color: #DC2626;
            color: white;
            border-color: #DC2626;
        }
        canvas {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
        }
        /* CSS cho modal */
        #javalab-modal {
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-blue-800">Bài Giảng Vật Lý Cùng Thầy Lâm</h1>
            <p class="text-xl mt-2 text-orange-500 font-semibold">Chủ đề: Khám Phá Sự Chuyển Thể</p>
             <div class="mt-4">
                 <a href="https://drive.google.com/file/d/1ecDZpW6Ie8x9YsE-qDT5VQaa7f6LLZAQ/view?usp=sharing" target="_blank" class="inline-block bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition shadow">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block w-5 h-5 mr-2 -mt-1"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
                    Tài liệu tham khảo
                </a>
            </div>
        </header>

        <div class="mb-8 border-b border-slate-200">
            <div class="flex -mb-px space-x-2 md:space-x-6 justify-center overflow-x-auto pb-2">
                <button class="tab-btn active text-sm md:text-base py-3 px-3 whitespace-nowrap" onclick="changeTab(event, 'tab1')">1. Sự Nóng Chảy</button>
                <button class="tab-btn text-sm md:text-base py-3 px-3 whitespace-nowrap" onclick="changeTab(event, 'tab2')">2. Sự Hóa Hơi</button>
                <button class="tab-btn quiz-tab text-sm md:text-base py-3 px-3 whitespace-nowrap" onclick="changeTab(event, 'tab3')">3. Ứng Dụng & Kiểm Tra</button>
            </div>
        </div>

        <main id="tab-container">
            <!-- Tab 1: Sự Nóng Chảy -->
            <div id="tab1" class="tab-content active">
                <div class="bg-white p-6 rounded-lg shadow-md mb-8 grid md:grid-cols-2 gap-8 items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-blue-700 mb-4">A. Kiến thức Nền tảng</h2>
                        <div class="space-y-4 text-slate-700">
                            <h3 class="font-semibold text-lg text-slate-800">1. Định nghĩa & Công thức</h3>
                            <p>Nhiệt lượng cần truyền cho một vật rắn để nó nóng chảy hoàn toàn ở nhiệt độ nóng chảy phụ thuộc vào khối lượng và bản chất của vật. Đại lượng đặc trưng cho khả năng này là <strong>nhiệt nóng chảy riêng ($\lambda$)</strong>.</p>
                            <p><strong>Công thức tính nhiệt lượng nóng chảy:</strong></p>
                            <div class="bg-blue-50 text-blue-800 p-4 rounded-lg text-center text-xl">$Q = m \cdot \lambda$</div>
                            <p><strong>Định nghĩa:</strong> Nhiệt nóng chảy riêng của một chất là nhiệt lượng cần thiết để 1kg chất đó chuyển hoàn toàn từ thể rắn sang thể lỏng ở nhiệt độ nóng chảy.</p>
                        </div>
                    </div>
                     <div class="flex flex-col items-center justify-center min-h-[350px]">
                        <h3 class="text-xl font-semibold mb-4 text-center">Mô phỏng phân tử</h3>
                        <canvas id="melting-canvas" width="300" height="250"></canvas>
                        <button id="start-melting-btn" class="mt-4 bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition">Bắt đầu mô phỏng</button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md mb-8 grid md:grid-cols-2 gap-8 items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-blue-700 mb-4">B. Quá trình & Đồ thị</h2>
                        <div class="space-y-4 text-slate-700">
                             <p>Khi đun một cục đá, quá trình diễn ra theo 3 giai đoạn, được minh họa trên đồ thị nhiệt độ - thời gian:</p>
                             <ul class="list-decimal list-inside ml-4 space-y-1">
                                 <li><strong>Giai đoạn 1 (Dốc lên):</strong> Nhiệt độ của đá tăng từ dưới 0°C lên đến 0°C.</li>
                                 <li><strong>Giai đoạn 2 (Nằm ngang):</strong> Nhiệt độ không đổi ở 0°C. Năng lượng cung cấp lúc này dùng hoàn toàn để phá vỡ liên kết, giúp đá tan chảy.</li>
                                 <li><strong>Giai đoạn 3 (Dốc lên):</strong> Khi đá tan hết, nhiệt độ của nước bắt đầu tăng.</li>
                             </ul>
                        </div>
                         <hr class="my-6 border-slate-200">
                         <h3 class="text-2xl font-bold text-orange-600 mb-4">Góc nhìn Thầy Lâm</h3>
                          <p class="text-slate-700">Hãy tưởng tượng các phân tử trong cục đá đang bị "giam cầm" trong một "nhà tù" trật tự. Để được "tự do" và chuyển thành lỏng, chúng phải trả một khoản "phí qua cửa". Nhiệt lượng ta cung cấp trong lúc nóng chảy chính là khoản phí đó. Nó không làm các phân tử "giàu" (nóng) lên, mà chỉ vừa đủ để chúng "mua vé" ra ngoài thôi!</p>
                    </div>
                    <div class="flex flex-col items-center justify-center min-h-[350px]">
                        <h3 class="text-xl font-semibold mb-4 text-center">Mô phỏng đồ thị</h3>
                        <svg id="svg-melting-graph" width="350" height="250" class="bg-slate-50 border rounded-lg"></svg>
                        <button class="mt-4 bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition" onclick="animateMeltingGraph()">Vẽ đồ thị</button>
                    </div>
                </div>

                 <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-r-lg">
                    <h3 class="font-bold text-xl text-blue-800 mb-2">Góc Tương Tác Cùng Thầy Lâm</h3>
                    <p class="mb-4">Em có câu hỏi gì về sự nóng chảy không?</p>
                    <form class="flex gap-2" onsubmit="handleAIChat(event, 'tab1')">
                        <input type="text" id="prompt-tab1" class="flex-grow p-2 border border-slate-300 rounded-lg" placeholder="Ví dụ: Tại sao nhiệt độ không đổi khi đá tan?">
                        <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition">Gửi</button>
                    </form>
                    <div id="response-tab1" class="mt-4 p-4 bg-white rounded-lg border hidden"></div>
                </div>
            </div>

            <!-- Tab 2: Sự Hóa Hơi -->
            <div id="tab2" class="tab-content">
                 <div class="bg-white p-6 rounded-lg shadow-md mb-8 grid md:grid-cols-2 gap-8 items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-blue-700 mb-4">A. Kiến thức Nền tảng</h2>
                         <div class="space-y-4 text-slate-700">
                             <h3 class="font-semibold text-lg text-slate-800">1. Định nghĩa & Công thức</h3>
                             <p>Tương tự sự nóng chảy, để một chất lỏng hóa hơi hoàn toàn ở nhiệt độ sôi, ta cần cung cấp một nhiệt lượng. Đại lượng đặc trưng cho quá trình này là <strong>nhiệt hóa hơi riêng (L)</strong>.</p>
                             <p><strong>Công thức tính nhiệt lượng hóa hơi:</strong></p>
                             <div class="bg-blue-50 text-blue-800 p-4 rounded-lg text-center text-xl">$Q = L \cdot m$</div>
                             <p><strong>Định nghĩa:</strong> Nhiệt hóa hơi riêng của một chất là nhiệt lượng cần thiết để 1kg chất đó chuyển hoàn toàn từ thể lỏng sang thể khí (hơi) ở nhiệt độ sôi.</p>
                         </div>
                    </div>
                     <div class="flex flex-col items-center justify-center min-h-[350px]">
                        <h3 class="text-xl font-semibold mb-4 text-center">Mô phỏng hóa hơi</h3>
                        <canvas id="boiling-canvas" width="300" height="250"></canvas>
                        <button class="mt-4 bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition" onclick="startBoiling()">Bắt đầu mô phỏng</button>
                    </div>
                </div>

                 <div class="bg-white p-6 rounded-lg shadow-md mb-8 grid md:grid-cols-2 gap-8 items-center">
                    <div>
                         <h2 class="text-2xl font-bold text-blue-700 mb-4">B. Quá trình & Đồ thị</h2>
                         <div class="space-y-4 text-slate-700">
                             <p>Khi đun sôi nước, quá trình cũng có các giai đoạn tương tự nóng chảy:</p>
                             <ul class="list-decimal list-inside ml-4 space-y-1">
                                 <li><strong>Giai đoạn 1 (Dốc lên):</strong> Nhiệt độ của nước tăng từ nhiệt độ phòng đến 100°C.</li>
                                 <li><strong>Giai đoạn 2 (Nằm ngang):</strong> Nhiệt độ không đổi ở 100°C. Năng lượng cung cấp lúc này dùng để "thắng" áp suất khí quyển và giúp nước hóa hơi.</li>
                                 <li><strong>Giai đoạn 3 (Dốc lên):</strong> Nếu có thể giữ hơi nước lại và tiếp tục đun, nhiệt độ của hơi sẽ tăng.</li>
                             </ul>
                         </div>
                          <hr class="my-6 border-slate-200">
                          <h2 class="text-2xl font-bold text-orange-600 mb-4">Góc nhìn Thầy Lâm</h2>
                          <div class="space-y-4 text-slate-700">
                              <p>Nếu nóng chảy là "mua vé qua cửa", thì hóa hơi chính là "mua vé máy bay hạng thương gia". Các phân tử nước không chỉ cần phá vỡ liên kết lỏng lẻo, mà còn cần một nguồn năng lượng cực lớn để "thăng cấp", bay vút lên bầu trời và trở thành hơi. Khoản năng lượng khổng lồ này chính là nhiệt hóa hơi riêng L.</p>
                          </div>
                    </div>
                     <div class="flex flex-col items-center justify-center min-h-[350px]">
                        <h3 class="text-xl font-semibold mb-4 text-center">Mô phỏng đồ thị</h3>
                        <svg id="svg-boiling-graph" width="350" height="250" class="bg-slate-50 border rounded-lg"></svg>
                        <button class="mt-4 bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition" onclick="animateBoilingGraph()">Vẽ đồ thị</button>
                    </div>
                </div>
                 <!-- THÊM MỚI: Thí nghiệm mở rộng -->
                 <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                     <h2 class="text-2xl font-bold text-blue-700 mb-4">C. Thí nghiệm Mở rộng</h2>
                     <p class="mb-4 text-slate-700">Để khám phá sâu hơn về điểm sôi và áp suất, em có thể tương tác với mô phỏng thí nghiệm từ JavaLab ngay tại đây.</p>
                     <button onclick="openModal()" class="bg-teal-500 text-white px-5 py-2 rounded-lg hover:bg-teal-600 transition shadow">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline w-5 h-5 mr-2 -mt-1"><path d="M15 3h6v6"></path><path d="M10 14 21 3"></path><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h6"></path></svg>
                        Mở Thí Nghiệm JavaLab
                    </button>
                 </div>
                 <!-- SỬA LỖI: Thêm lại Góc Tương Tác -->
                  <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-r-lg">
                    <h3 class="font-bold text-xl text-blue-800 mb-2">Góc Tương Tác Cùng Thầy Lâm</h3>
                    <p class="mb-4">Em có thắc mắc gì về sự hóa hơi không? Hãy hỏi thầy!</p>
                    <form class="flex gap-2" onsubmit="handleAIChat(event, 'tab2')">
                        <input type="text" id="prompt-tab2" class="flex-grow p-2 border border-slate-300 rounded-lg" placeholder="Ví dụ: Tại sao nước sôi ở 100 độ C?">
                        <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition">Gửi</button>
                    </form>
                    <div id="response-tab2" class="mt-4 p-4 bg-white rounded-lg border hidden"></div>
                </div>
            </div>

            <!-- Tab 3: Ứng Dụng & Kiểm tra -->
            <div id="tab3" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                     <h2 class="text-2xl font-bold text-blue-700 mb-4">Phần 1: So sánh Nóng chảy và Hóa hơi</h2>
                     <table class="w-full text-left border-collapse">
                         <thead>
                             <tr class="bg-slate-100">
                                 <th class="p-3 border">Đặc điểm</th>
                                 <th class="p-3 border">Sự Nóng Chảy</th>
                                 <th class="p-3 border">Sự Hóa Hơi</th>
                             </tr>
                         </thead>
                         <tbody>
                             <tr>
                                 <td class="p-3 border font-semibold">Chuyển thể</td>
                                 <td class="p-3 border">Rắn → Lỏng</td>
                                 <td class="p-3 border">Lỏng → Khí (Hơi)</td>
                             </tr>
                             <tr>
                                 <td class="p-3 border font-semibold">Nhiệt độ</td>
                                 <td class="p-3 border">Không đổi ở nhiệt độ nóng chảy</td>
                                 <td class="p-3 border">Không đổi ở nhiệt độ sôi</td>
                             </tr>
                              <tr>
                                 <td class="p-3 border font-semibold">Đại lượng</td>
                                 <td class="p-3 border">Nhiệt nóng chảy riêng ($\lambda$)</td>
                                 <td class="p-3 border">Nhiệt hóa hơi riêng (L)</td>
                             </tr>
                             <tr>
                                 <td class="p-3 border font-semibold">Năng lượng</td>
                                 <td class="p-3 border">Phá vỡ liên kết tinh thể</td>
                                 <td class="p-3 border">Phá vỡ liên kết lỏng & thắng áp suất ngoài</td>
                             </tr>
                         </tbody>
                     </table>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                     <h2 class="text-2xl font-bold text-blue-700 mb-4">Phần 2: Ứng dụng đời sống</h2>
                     <div class="grid md:grid-cols-2 gap-8 items-center">
                         <div>
                            <h3 class="font-semibold text-lg text-slate-800 mb-2">Ứng dụng của sự nóng chảy:</h3>
                            <p><strong>Ướp lạnh thực phẩm:</strong> Đá phải thu một lượng nhiệt lớn từ thực phẩm để tan chảy, qua đó làm lạnh và bảo quản chúng. Đây là lý do đá giữ lạnh tốt hơn nước lạnh rất nhiều!</p>
                             <h3 class="font-semibold text-lg text-slate-800 mt-4 mb-2">Ứng dụng của sự hóa hơi:</h3>
                             <p><strong>Nồi áp suất:</strong> Bằng cách tăng áp suất, nồi làm tăng nhiệt độ sôi của nước, giúp thức ăn chín nhanh hơn. Khi xả van, hơi nước mang theo một lượng nhiệt lớn thoát ra ngoài.</p>
                             <p class="mt-2"><strong>Làm mát:</strong> Khi ta đổ mồ hôi, mồ hôi bay hơi và lấy đi một lượng nhiệt lớn trên da, giúp cơ thể hạ nhiệt.</p>
                         </div>
                         <div class="flex flex-col items-center justify-center">
                            <h3 class="text-xl font-semibold mb-4 text-center">Mô phỏng: Ly nước đá "thần kỳ"</h3>
                            <svg id="svg-tab3" width="300" height="200" viewBox="0 0 300 200"></svg>
                            <button class="mt-4 bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition" onclick="animateApplication()">Xem ứng dụng</button>
                        </div>
                     </div>
                </div>

                <div id="quiz-container" class="max-w-3xl mx-auto bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-center text-green-700 mb-6">Phần 3: Kiểm Tra Kiến Thức</h2>
                    <div id="quiz-question" class="text-lg font-semibold mb-6 min-h-[50px]"></div>
                    <div id="quiz-options" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    <button id="quiz-next-btn" class="w-full mt-8 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-bold hidden" onclick="nextQuestion()">Câu tiếp theo</button>
                </div>
                <div id="quiz-results" class="hidden max-w-3xl mx-auto bg-white p-8 rounded-xl shadow-lg text-center">
                     <h2 class="text-3xl font-bold text-green-700 mb-4">Hoàn thành!</h2>
                     <p class="text-lg mb-2">Kết quả của em:</p>
                     <p id="quiz-score" class="text-5xl font-bold text-orange-500 my-4"></p>
                     <p id="quiz-feedback" class="text-slate-600 font-style: italic"></p>
                     <button class="mt-8 bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition font-bold" onclick="restartQuiz()">Làm lại</button>
                </div>
            </div>

        </main>
    </div>

    <!-- THÊM MỚI: Modal cho JavaLab -->
    <div id="javalab-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-5xl h-[90vh] flex flex-col">
            <div class="p-3 border-b flex justify-between items-center bg-slate-50 rounded-t-lg">
                <h3 class="font-bold text-slate-700">Thí nghiệm từ JavaLab.org</h3>
                <button onclick="closeModal()" class="px-3 py-1 bg-red-500 text-white rounded-full text-lg font-bold hover:bg-red-600 transition">&times;</button>
            </div>
            <iframe id="javalab-iframe" class="w-full h-full border-0" allow="fullscreen"></iframe>
        </div>
    </div>


    <script>
        // --------- HỆ THỐNG TAB ---------
        function changeTab(event, tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
            if (tabId === 'tab3') {
                drawApplicationScene(false);
            }
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                     delimiters: [{left: "$", right: "$", display: false}]
                });
            }
        }

        // --------- CÁC HÀM MÔ PHỎNG ---------

        // --- Mô phỏng Nóng chảy (Tab 1) ---
        const setupMeltingCanvas = () => {
            const canvas = document.getElementById('melting-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const btn = document.getElementById('start-melting-btn');
            let particles = [], animationFrameId;
            const STATES = { IDLE: 'IDLE', HEATING: 'HEATING', MELTING: 'MELTING' };
            let currentState = STATES.IDLE;

            class Particle {
                constructor(x, y) {
                    this.x = x; this.y = y; this.originX = x; this.originY = y;
                    this.radius = 8; this.color = '#3b82f6';
                    this.vx = (Math.random() - 0.5) * 1.5; this.vy = (Math.random() - 0.5) * 1.5;
                    this.vibrationAmplitude = 0;
                }
                draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); ctx.fillStyle = this.color; ctx.fill(); }
                update() {
                    if (currentState === STATES.HEATING) {
                        this.x = this.originX + (Math.random() - 0.5) * this.vibrationAmplitude;
                        this.y = this.originY + (Math.random() - 0.5) * this.vibrationAmplitude;
                    } else if (currentState === STATES.MELTING) {
                        this.x += this.vx; this.y += this.vy;
                        if (this.x < this.radius || this.x > canvas.width - this.radius) this.vx *= -1;
                        if (this.y < this.radius || this.y > canvas.height - this.radius) this.vy *= -1;
                    }
                }
            }

            function init() {
                currentState = STATES.IDLE;
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                particles = [];
                const padding = 40, numCols = 5, numRows = 5;
                const spacingX = (canvas.width - padding * 2) / (numCols - 1);
                const spacingY = (canvas.height - padding * 2) / (numRows - 1);
                for (let i = 0; i < numCols; i++) for (let j = 0; j < numRows; j++) particles.push(new Particle(padding + i * spacingX, padding + j * spacingY));
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => p.draw());
                btn.textContent = "Bắt đầu mô phỏng"; btn.disabled = false;
            }

            let globalVibration = 0;
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (currentState === STATES.HEATING) {
                    if (globalVibration < 8) globalVibration += 0.06;
                    else { currentState = STATES.MELTING; btn.textContent = "Thiết lập lại"; btn.disabled = false; }
                }
                particles.forEach(p => { if (currentState === STATES.HEATING) p.vibrationAmplitude = globalVibration; p.update(); p.draw(); });
                animationFrameId = requestAnimationFrame(animate);
            }
            btn.addEventListener('click', () => {
                if (currentState === STATES.IDLE) {
                    currentState = STATES.HEATING; globalVibration = 0;
                    btn.textContent = "Đang làm nóng..."; btn.disabled = true;
                    animate();
                } else init();
            });
            init();
        }

        // --- Mô phỏng Hóa hơi (Tab 2) ---
        let boilingAnimationId = null;
        function startBoiling() {
            const canvas = document.getElementById('boiling-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let bubbles = []; let waterLevel = 220;
            const btn = document.querySelector('button[onclick="startBoiling()"]');

            if (boilingAnimationId) {
                cancelAnimationFrame(boilingAnimationId);
                boilingAnimationId = null;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                btn.textContent = "Bắt đầu mô phỏng";
                return;
            }
            
            btn.textContent = "Dừng lại";

            class Bubble {
                constructor() {
                    this.x = Math.random() * (canvas.width - 40) + 20;
                    this.y = waterLevel;
                    this.radius = Math.random() * 4 + 1;
                    this.vy = -Math.random() * 1.5 - 0.5;
                }
                draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); ctx.strokeStyle = 'rgba(255,255,255,0.8)'; ctx.stroke(); }
                update() { this.y += this.vy; }
            }
            
            function animate() {
                ctx.fillStyle = '#f0f9ff'; 
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillRect(0, 0, canvas.width, canvas.height); // Fill background
                ctx.fillStyle = '#3b82f6'; // Water color
                ctx.fillRect(0, canvas.height - waterLevel, canvas.width, waterLevel);

                if (Math.random() < 0.6 && bubbles.length < 80) bubbles.push(new Bubble());
                
                for(let i = bubbles.length - 1; i >= 0; i--) {
                    bubbles[i].update();
                    bubbles[i].draw();
                    if(bubbles[i].y < canvas.height - waterLevel) bubbles.splice(i, 1);
                }

                if (waterLevel > 150) waterLevel -= 0.05;

                boilingAnimationId = requestAnimationFrame(animate);
            }
            animate();
        }

        // CẬP NHẬT HIỆU ỨNG VẼ ĐỒ THỊ
        function animateGraph(svgId, pathData) {
            const svg = document.getElementById(svgId);
            if (!svg) return;
            svg.innerHTML = '';

            const axisX = document.createElementNS("http://www.w3.org/2000/svg", "line");
            axisX.setAttribute("x1", 40); axisX.setAttribute("y1", 200); axisX.setAttribute("x2", 340); axisX.setAttribute("y2", 200);
            axisX.setAttribute("stroke", "#334155"); axisX.setAttribute("stroke-width", "2");

            const axisY = document.createElementNS("http://www.w3.org/2000/svg", "line");
            axisY.setAttribute("x1", 50); axisY.setAttribute("y1", 210); axisY.setAttribute("x2", 50); axisY.setAttribute("y2", 10);
            axisY.setAttribute("stroke", "#334155"); axisY.setAttribute("stroke-width", "2");
            
            svg.appendChild(axisX);
            svg.appendChild(axisY);

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", pathData);
            path.setAttribute("fill", "none");
            path.setAttribute("stroke", "#F97316");
            path.setAttribute("stroke-width", "4");
            path.setAttribute("stroke-linecap", "round");
            
            svg.appendChild(path);
            const pathLength = path.getTotalLength();
            
            path.setAttribute("stroke-dasharray", pathLength);
            path.setAttribute("stroke-dashoffset", pathLength);

            path.innerHTML = `
                <animate attributeName="stroke-dashoffset" 
                    from="${pathLength}" to="0" dur="2s" begin="0.5s" 
                    fill="freeze" calcMode="spline" keyTimes="0; 1" keySplines="0.42 0 0.58 1" />
            `;
        }

        function animateMeltingGraph() {
            animateGraph('svg-melting-graph', "M 50 180 L 120 150 L 250 150 L 320 80");
        }
        
        function animateBoilingGraph() {
            animateGraph('svg-boiling-graph', "M 50 180 L 120 80 L 250 80 L 320 40");
        }

        // --- Mô phỏng ứng dụng (Tab 3) ---
        function drawApplicationScene(isAnimated = false) {
            const svg = document.getElementById('svg-tab3');
            if (!svg) return;
            svg.innerHTML = ''; 
            const glass = document.createElementNS("http://www.w3.org/2000/svg", "path");
            glass.setAttribute("d", "M80 30 L 100 180 H 200 L 220 30 Z");
            glass.setAttribute("stroke", "#9CA3AF"); glass.setAttribute("stroke-width", "3"); glass.setAttribute("fill", "rgba(100,150,255,0.1)");
            svg.appendChild(glass);
            const drink = document.createElementNS("http://www.w3.org/2000/svg", "path");
            drink.setAttribute("d", "M85 50 L 100 170 H 200 L 215 50 Z"); drink.setAttribute("fill", "#FBBF24");
            svg.appendChild(drink);
            const iceCube = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            iceCube.setAttribute("x", "130"); iceCube.setAttribute("y", "60"); iceCube.setAttribute("width", "40"); iceCube.setAttribute("height", "40");
            iceCube.setAttribute("fill", "white"); iceCube.setAttribute("stroke", "#60A5FA"); iceCube.setAttribute("stroke-width", "2"); iceCube.setAttribute("rx", "5");
            svg.appendChild(iceCube);
            
            if (isAnimated) {
                iceCube.innerHTML = `<animate attributeName="width" from="40" to="5" dur="8s" fill="freeze" /><animate attributeName="height" from="40" to="5" dur="8s" fill="freeze" /><animate attributeName="x" from="130" to="147.5" dur="8s" fill="freeze" /><animate attributeName="y" from="60" to="77.5" dur="8s" fill="freeze" /><animate attributeName="opacity" from="1" to="0" begin="7.5s" dur="0.5s" fill="freeze" />`;
                const heatPositions = [ { x: 105, y: 150 }, { x: 195, y: 150 }, { x: 110, y: 100 }, { x: 190, y: 100 }, { x: 120, y: 130 }, { x: 180, y: 130 } ];
                const iceCenter = { x: 150, y: 80 };
                heatPositions.forEach((pos, i) => {
                    const heat = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    heat.setAttribute("cx", pos.x); heat.setAttribute("cy", pos.y); heat.setAttribute("r", "4"); heat.setAttribute("fill", "#ef4444"); heat.setAttribute("opacity", "0");
                    svg.appendChild(heat);
                    heat.innerHTML = `<animate attributeName="opacity" values="0; 1; 1; 0" dur="2.5s" begin="${i * 0.5}s" repeatCount="indefinite" /><animateMotion path="M0,0 Q${(iceCenter.x - pos.x)*0.5},${(iceCenter.y - pos.y)*0.5} ${iceCenter.x - pos.x},${iceCenter.y - pos.y}" dur="2.5s" begin="${i * 0.5}s" repeatCount="indefinite" /><animate attributeName="r" from="4" to="0" dur="2.5s" begin="${i * 0.5}s" repeatCount="indefinite" />`;
                });
            }
        }
        function animateApplication() { drawApplicationScene(true); }

        // --------- HỆ THỐNG QUIZ ---------
        const quizData = [
            { question: "Trong quá trình nóng chảy, nhiệt độ của vật...", options: ["Tăng dần", "Giảm dần", "Không thay đổi", "Tăng rồi giảm"], correct: 2 },
            { question: "Công thức tính nhiệt lượng hóa hơi là:", options: ["Q = m.c.Δt", "Q = λ.m", "Q = L.m", "Q = m.g.h"], correct: 2 },
            { question: "Nhiệt hóa hơi riêng (L) có đơn vị là:", options: ["J", "J/kg", "J/kg.°C", "°C"], correct: 1 },
            { question: "Tại sao mồ hôi bay hơi lại giúp cơ thể mát hơn?", options: ["Vì mồ hôi lạnh", "Vì bay hơi là quá trình thu nhiệt lượng lớn", "Vì gió thổi mát", "Vì da trở nên khô ráo"], correct: 1 },
            { question: "Đoạn nằm ngang trên đồ thị sôi biểu thị điều gì?", options: ["Nước đang nóng lên", "Nước đang hóa hơi ở nhiệt độ không đổi", "Nước đang nguội đi", "Nhiệt kế bị hỏng"], correct: 1 }
        ];

        let currentQuestionIndex = 0, score = 0;
        function startQuiz() {
            currentQuestionIndex = 0; score = 0;
            document.getElementById('quiz-container').style.display = 'block';
            document.getElementById('quiz-results').style.display = 'none';
            document.getElementById('quiz-next-btn').style.display = 'none';
            showQuestion();
        }
        function showQuestion() {
            const questionEl = document.getElementById('quiz-question');
            const optionsEl = document.getElementById('quiz-options');
            optionsEl.innerHTML = '';
            questionEl.textContent = `${currentQuestionIndex + 1}. ${quizData[currentQuestionIndex].question}`;
            quizData[currentQuestionIndex].options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('quiz-option', 'p-4', 'border-2', 'rounded-lg', 'text-left', 'transition-all');
                button.addEventListener('click', () => selectAnswer(button, index));
                optionsEl.appendChild(button);
            });
        }
        function selectAnswer(selectedBtn, selectedIndex) {
            const correctIndex = quizData[currentQuestionIndex].correct;
            Array.from(document.getElementById('quiz-options').children).forEach((btn, index) => {
                btn.disabled = true;
                if (index === correctIndex) btn.classList.add('correct');
                else if (index === selectedIndex) btn.classList.add('incorrect');
            });
            if (selectedIndex === correctIndex) score++;
            document.getElementById('quiz-next-btn').style.display = 'block';
        }
        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizData.length) {
                document.getElementById('quiz-next-btn').style.display = 'none';
                showQuestion();
            } else showResults();
        }
        function showResults() {
            document.getElementById('quiz-container').style.display = 'none';
            const resultsContainer = document.getElementById('quiz-results');
            resultsContainer.style.display = 'block';
            document.getElementById('quiz-score').textContent = `${score}/${quizData.length}`;
            const percentage = (score / quizData.length) * 100;
            let feedback = "Cố gắng hơn nhé!";
            if (percentage === 100) feedback = "Tuyệt vời! Em đã là chuyên gia chuyển thể!";
            else if (percentage >= 60) feedback = "Làm tốt lắm! Em đã nắm vững kiến thức.";
            document.getElementById('quiz-feedback').textContent = feedback;
        }
        function restartQuiz() { startQuiz(); }
        
        // --- THÊM MỚI: Modal ---
        function openModal() {
            const modal = document.getElementById('javalab-modal');
            const iframe = document.getElementById('javalab-iframe');
            iframe.src = "https://javalab.org/en/boiling_point_en/";
            modal.classList.remove('hidden');
        }

        function closeModal() {
            const modal = document.getElementById('javalab-modal');
            const iframe = document.getElementById('javalab-iframe');
            iframe.src = ""; // Dừng iframe để tiết kiệm tài nguyên
            modal.classList.add('hidden');
        }
        
        // --------- HỆ THỐNG TƯƠNG TÁC AI ---------
        const apiKey = "AIzaSyCtpvVNCZzRr59N-mISm5MVzJ5pVuj9Qxk";
        async function handleAIChat(event, tabId) { 
            event.preventDefault(); 
            const promptInput = document.getElementById(`prompt-${tabId}`); 
            const responseDiv = document.getElementById(`response-${tabId}`); 
            const userInput = promptInput.value.trim(); 
            if (!userInput) return; 
            responseDiv.textContent = 'Để thầy vận công một chút... Thầy đang kết nối với vũ trụ vật lý...'; 
            responseDiv.style.display = 'block'; 
            promptInput.disabled = true; 
            event.target.querySelector('button').disabled = true; 
            const topic = tabId === 'tab1' ? 'sự nóng chảy' : 'sự hóa hơi';
            const structuredPrompt = `
                Bối cảnh: Một học sinh đang hỏi trong bài giảng online về chủ đề "${topic}".
                ---
                Luật Lệ Bất Di Bất Dịch của bạn:
                1.  **Nhân vật:** Bạn là "Thầy Lâm", một thầy giáo dạy Vật lý không chỉ có tâm mà còn có cả "muối". Phong cách của bạn là biến kiến thức khô khan thành những câu chuyện cười ra nước mắt, dùng ví dụ "bá đạo" và so sánh oái oăm để học sinh nhớ bài đến già.
                2.  **Nhiệm vụ:** Trả lời câu hỏi của học sinh với giọng văn hài hước, dí dỏm, thông minh nhưng vẫn phải đảm bảo kiến thức vật lý chính xác liên quan đến chủ đề được hỏi.
                3.  **Từ chối "ngoài luồng":** Nếu học sinh hỏi chuyện không liên quan, hãy từ chối một cách thật hài hước theo đúng phong cách của Thầy Lâm. Ví dụ: "Câu hỏi đó thuộc một vũ trụ khác rồi em ơi, để tiết sau chúng ta du hành đến đó nhé. Giờ thì quay lại với vương quốc băng giá của chúng ta nào!"
                ---
                Câu hỏi của học sinh: "${userInput}"
                ---
                Hãy trả lời câu hỏi trên.`; 
            try { 
                const response = await callGemini(structuredPrompt); 
                responseDiv.textContent = response; 
            } catch (error) { 
                console.error("Error:", error); 
                responseDiv.textContent = 'Ối, hình như mạng nhà thầy vừa bị "nóng chảy" rồi. Em hỏi lại sau vài giây nhé!'; 
            } finally { 
                promptInput.disabled = false; 
                event.target.querySelector('button').disabled = false; 
                promptInput.value = ''; 
            } 
        }
        async function callGemini(promptText) { const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`; const payload = { contents: [{ parts: [{ text: promptText }] }] }; const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) throw new Error(`API call failed: ${response.status}`); const result = await response.json(); if (result.candidates && result.candidates.length > 0) { return result.candidates[0].content.parts[0].text; } return "Rất tiếc, thầy chưa nghĩ ra câu trả lời phù hợp."; }

        // --------- KHỞI TẠO KHI TẢI TRANG ---------
        window.onload = () => {
            setupMeltingCanvas();
            startQuiz();
            if (window.renderMathInElement) {
                renderMathInElement(document.body, { delimiters: [{left: "$", right: "$", display: false}] });
            }
        };
    </script>
</body>
</html>
